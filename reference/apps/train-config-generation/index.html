
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://github.com/Gradiant/pyodi/reference/apps/train-config-generation/">
      
      <link rel="shortcut icon" href="../../../images/logo.svg">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.8">
    
    
      
        <title>generation - Python Object Detection Insights</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pyodi.apps.train_config.train_config_generation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://github.com/Gradiant/pyodi" title="Python Object Detection Insights" class="md-header-nav__button md-logo" aria-label="Python Object Detection Insights">
      
  <img src="../../../images/logo.svg" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Python Object Detection Insights
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              generation
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://github.com/Gradiant/pyodi" title="Python Object Detection Insights" class="md-nav__button md-logo" aria-label="Python Object Detection Insights">
      
  <img src="../../../images/logo.svg" alt="logo">

    </a>
    Python Object Detection Insights
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
      
      <label class="md-nav__link" for="nav-3">
        Reference
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1" checked>
      
      <label class="md-nav__link" for="nav-3-1">
        apps
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="apps" data-md-level="2">
        <label class="md-nav__title" for="nav-3-1">
          <span class="md-nav__icon md-icon"></span>
          apps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-1" type="checkbox" id="nav-3-1-1" >
      
      <label class="md-nav__link" for="nav-3-1-1">
        coco
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="coco" data-md-level="3">
        <label class="md-nav__title" for="nav-3-1-1">
          <span class="md-nav__icon md-icon"></span>
          coco
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../coco-merge/" class="md-nav__link">
        merge
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../coco-split/" class="md-nav__link">
        split
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-2" type="checkbox" id="nav-3-1-2" >
      
      <label class="md-nav__link" for="nav-3-1-2">
        crops
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="crops" data-md-level="3">
        <label class="md-nav__title" for="nav-3-1-2">
          <span class="md-nav__icon md-icon"></span>
          crops
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../crops-merge/" class="md-nav__link">
        merge
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../crops-split/" class="md-nav__link">
        split
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/" class="md-nav__link">
        evaluation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ground-truth/" class="md-nav__link">
        ground-truth
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../paint-annotations/" class="md-nav__link">
        paint-annotations
      </a>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-6" type="checkbox" id="nav-3-1-6" checked>
      
      <label class="md-nav__link" for="nav-3-1-6">
        train-config
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="train-config" data-md-level="3">
        <label class="md-nav__title" for="nav-3-1-6">
          <span class="md-nav__icon md-icon"></span>
          train-config
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../train-config-evaluation/" class="md-nav__link">
        evaluation
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          generation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        generation
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation" class="md-nav__link">
    pyodi.apps.train_config.train_config_generation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--train-config-generation-app" class="md-nav__link">
    Train Config Generation App.
  </a>
  
    <nav class="md-nav" aria-label="Train Config Generation App.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--procedure" class="md-nav__link">
    Procedure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--log-relative-scale-vs-log-ratio" class="md-nav__link">
    Log Relative Scale vs Log Ratio
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--bounding-box-distribution" class="md-nav__link">
    Bounding Box Distribution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--api-reference" class="md-nav__link">
    API REFERENCE
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation.train_config_generation" class="md-nav__link">
    train_config_generation()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2" >
      
      <label class="md-nav__link" for="nav-3-2">
        core
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="core" data-md-level="2">
        <label class="md-nav__title" for="nav-3-2">
          <span class="md-nav__icon md-icon"></span>
          core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../core/anchor_generator/" class="md-nav__link">
        anchor_generator
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../core/boxes/" class="md-nav__link">
        boxes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../core/clustering/" class="md-nav__link">
        clustering
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../core/crops/" class="md-nav__link">
        crops
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../core/nms/" class="md-nav__link">
        nms
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../core/utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3" >
      
      <label class="md-nav__link" for="nav-3-3">
        plots
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="plots" data-md-level="2">
        <label class="md-nav__title" for="nav-3-3">
          <span class="md-nav__icon md-icon"></span>
          plots
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../plots/boxes/" class="md-nav__link">
        boxes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../plots/clustering/" class="md-nav__link">
        clustering
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../plots/common/" class="md-nav__link">
        common
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../plots/evaluation/" class="md-nav__link">
        evaluation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation" class="md-nav__link">
    pyodi.apps.train_config.train_config_generation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--train-config-generation-app" class="md-nav__link">
    Train Config Generation App.
  </a>
  
    <nav class="md-nav" aria-label="Train Config Generation App.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--procedure" class="md-nav__link">
    Procedure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--log-relative-scale-vs-log-ratio" class="md-nav__link">
    Log Relative Scale vs Log Ratio
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--bounding-box-distribution" class="md-nav__link">
    Bounding Box Distribution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation--api-reference" class="md-nav__link">
    API REFERENCE
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyodi.apps.train_config.train_config_generation.train_config_generation" class="md-nav__link">
    train_config_generation()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>generation</h1>
                
                <div class="doc doc-object doc-module">
<h2 class="hidden-toc" id="pyodi.apps.train_config.train_config_generation" style="visibility: hidden; position: absolute;">
        </h2>
<div class="doc doc-contents first">
<h2 id="pyodi.apps.train_config.train_config_generation--train-config-generation-app">Train Config Generation App.</h2>
<p>The <a href="#pyodi.apps.train_config.train_config_generation.train_config_generation"><code>pyodi train-config generation</code></a>
app can be used to automatically generate a <a href="https://github.com/open-mmlab/mmdetection">mmdetection</a>
anchor configuration to train your model.</p>
<p>The design of anchors is critical for the performance of one-stage detectors. Usually, published models
such <a href="https://arxiv.org/abs/1506.01497">Faster R-CNN</a> or <a href="https://arxiv.org/abs/1708.02002">RetinaNet</a>
include default anchors which has been designed to work with general object detection purpose as COCO dataset.
Nevertheless, you might be envolved in different problems which data contains only a few different classes that
share similar properties, as the object sizes or shapes, this would be the case for a drone detection dataset
such <a href="https://wosdetc2020.wordpress.com/">Drone vs Bird</a>. You can exploit this knowledge by designing anchors
that specially fit the distribution of your data, optimizing the probability of matching ground truth bounding
boxes with generated anchors, which can result in an increase in the performance of your model. At the same time,
you can reduce the number of anchors you use to boost inference and training time.</p>
<h3 id="pyodi.apps.train_config.train_config_generation--procedure">Procedure</h3>
<p>The input size parameter determines the model input size and automatically reshapes images and annotations sizes to it.
Ground truth boxes are assigned to the anchor base size that has highest Intersection
over Union (IoU) score with them. This step, allow us to locate each ground truth
bounding box in a feature level of the FPN pyramid.</p>
<p>Once this is done, the ratio between the scales of ground truth boxes and the scales of
their associated anchors is computed. A log transform is applied to it and they are clustered
using kmeans algorithm, where the number of obtained clusters depends on <code>n_scales</code> input parameter.</p>
<p>After this step, a similar procedure is followed to obtain the reference scale ratios of the
dataset, computing log scales ratios of each box and clustering them with number of
clusters equal to <code>n_ratios</code>.</p>
<p>Example usage:</p>
<div class="codehilite">
<pre><span></span><code>pyodi train-config generation <span class="se">\\</span>
<span class="nv">$TINY_COCO_ANIMAL</span>/annotations/train.json <span class="se">\\</span>
--input-size <span class="o">[</span><span class="m">1280</span>,720<span class="o">]</span> <span class="se">\\</span>
--n-ratios <span class="m">3</span> --n-scales <span class="m">3</span>
</code></pre>
</div>
<p>The app shows two different plots:</p>
<p><img alt="Anchor clustering plot" src="../../../images/train-config-generation/clusters.png#center" /></p>
<h3 id="pyodi.apps.train_config.train_config_generation--log-relative-scale-vs-log-ratio">Log Relative Scale vs Log Ratio</h3>
<p>In this graphic you can distinguish how your bounding boxes scales and ratios are
distributed. The x axis represent the log scale of the ratio between the bounding box
scales and the scale of their matched anchor base size. The y axis contains the bounding
box log ratios. Centroids are the result of combinating the obtained scales and ratios
obtained with kmeans. We can see how clusters appear in those areas where box distribution is more dense.</p>
<p>We could increase the value of <code>n_ratios</code> from three to four, having into account that
the number of anchors is goint to increase, which will influence training computational cost.</p>
<div class="codehilite">
<pre><span></span><code>pyodi train-config generation annotations/train.json --input-size <span class="o">[</span><span class="m">1280</span>,720<span class="o">]</span> --n-ratios <span class="m">4</span> --n-scales <span class="m">3</span>
</code></pre>
</div>
<p>In plot below we can observe the result for <code>n_ratios</code> equal to four.</p>
<p><img alt="Anchor clustering plot 4 ratios" src="../../../images/train-config-generation/clusters_4_ratios.png#center" /></p>
<h3 id="pyodi.apps.train_config.train_config_generation--bounding-box-distribution">Bounding Box Distribution</h3>
<p>This plot is very useful to observe how the generated anchors fit you bounding box
distribution. The number of anchors depends on:</p>
<ul>
<li>The length of <code>base_sizes</code> which determines the number of FPN pyramid levels.</li>
<li>A total of <code>n_ratios</code> x <code>n_scales</code> anchors is generated per level</li>
</ul>
<p>We can now increase the number of <code>n_scales</code> and observe the effect on the bounding box distribution plot.</p>
<p><img alt="Anchor clustering plot 4 scales" src="../../../images/train-config-generation/clusters_4_scales.png#center" /></p>
<p>Proposed anchors are also attached in a Json file that follows
<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/anchor/anchor_generator.py#L10">mmdetection anchors</a> format:</p>
<div class="codehilite">
<pre><span></span><code><span class="n">anchor_generator</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="s1">'AnchorGenerator'</span><span class="p">,</span>
    <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mf">1.12</span><span class="p">,</span> <span class="mf">3.13</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">],</span>
    <span class="n">ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">],</span>
    <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
    <span class="n">base_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
<span class="p">)</span>
</code></pre>
</div>
<p>By default, <a href="../train-config-evaluation/#pyodi.apps.train_config.train_config_evaluation.train_config_evaluation"><code>pyodi train-config evaluation</code></a> is
used after the generation of anchors in order to compare which generated anchor config suits better your data.
You can disable this evaluation by setting to False the <code>evaluate</code> argument, but it is strongly advised to
use the anchor evaluation module.</p>
<hr />
<h2 id="pyodi.apps.train_config.train_config_generation--api-reference">API REFERENCE</h2>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="pyodi.apps.train_config.train_config_generation.train_config_generation">

<code class="highlight language-python"><span class="n">train_config_generation</span><span class="p">(</span><span class="n">ground_truth_file</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">),</span> <span class="n">n_ratios</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_scales</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span> <span class="n">keep_ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


      </h2>
<div class="doc doc-contents ">
<p>Computes optimal anchors for a given COCO dataset based on iou clustering.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ground_truth_file</code></td>
<td><code>str</code></td>
<td>
<p>Path to COCO ground truth file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>input_size</code></td>
<td><code>Tuple[int, int]</code></td>
<td>
<p>Model image input size. Defaults to (1280, 720).</p>
</td>
<td><code>(1280, 720)</code></td>
</tr>
<tr>
<td><code>n_ratios</code></td>
<td><code>int</code></td>
<td>
<p>Number of ratios. Defaults to 3.</p>
</td>
<td><code>3</code></td>
</tr>
<tr>
<td><code>n_scales</code></td>
<td><code>int</code></td>
<td>
<p>Number of scales. Defaults to 3.</p>
</td>
<td><code>3</code></td>
</tr>
<tr>
<td><code>strides</code></td>
<td><code>Optional[List[int]]</code></td>
<td>
<p>List of strides. Defatults to [4, 8, 16, 32, 64].</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>base_sizes</code></td>
<td><code>Optional[List[int]]</code></td>
<td>
<p>The basic sizes of anchors in multiple levels.
If None is given, strides will be used as base_sizes.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>show</code></td>
<td><code>bool</code></td>
<td>
<p>Show results or not. Defaults to True.</p>
</td>
<td><code>True</code></td>
</tr>
<tr>
<td><code>output</code></td>
<td><code>Optional[str]</code></td>
<td>
<p>Output directory where results going to be saved. Defaults to None.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>output_size</code></td>
<td><code>Tuple[int, int]</code></td>
<td>
<p>Size of saved images. Defaults to (1600, 900).</p>
</td>
<td><code>(1600, 900)</code></td>
</tr>
<tr>
<td><code>keep_ratio</code></td>
<td><code>bool</code></td>
<td>
<p>Whether to keep the aspect ratio or not. Defaults to False.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>evaluate</code></td>
<td><code>bool</code></td>
<td>
<p>Whether to evaluate or not the anchors. Check
<a href="../train-config-evaluation/#pyodi.apps.train_config.train_config_evaluation.train_config_evaluation"><code>pyodi train-config evaluation</code></a>
for more information.</p>
</td>
<td><code>True</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>None</code></td>
<td>
<p>Anchor generator instance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
          <summary>Source code in <code>pyodi/apps/train_config/train_config_generation.py</code></summary>
          <div class="highlight">
<pre><span></span><code><span class="nd">@logger</span><span class="o">.</span><span class="n">catch</span>
<span class="k">def</span> <span class="nf">train_config_generation</span><span class="p">(</span>
    <span class="n">ground_truth_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">),</span>
    <span class="n">n_ratios</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">n_scales</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">strides</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">base_sizes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span>
    <span class="n">keep_ratio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">evaluate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Computes optimal anchors for a given COCO dataset based on iou clustering.</span>

<span class="sd">    Args:</span>
<span class="sd">        ground_truth_file: Path to COCO ground truth file.</span>
<span class="sd">        input_size: Model image input size. Defaults to (1280, 720).</span>
<span class="sd">        n_ratios: Number of ratios. Defaults to 3.</span>
<span class="sd">        n_scales: Number of scales. Defaults to 3.</span>
<span class="sd">        strides: List of strides. Defatults to [4, 8, 16, 32, 64].</span>
<span class="sd">        base_sizes: The basic sizes of anchors in multiple levels.</span>
<span class="sd">            If None is given, strides will be used as base_sizes.</span>
<span class="sd">        show: Show results or not. Defaults to True.</span>
<span class="sd">        output: Output directory where results going to be saved. Defaults to None.</span>
<span class="sd">        output_size: Size of saved images. Defaults to (1600, 900).</span>
<span class="sd">        keep_ratio: Whether to keep the aspect ratio or not. Defaults to False.</span>
<span class="sd">        evaluate: Whether to evaluate or not the anchors. Check</span>
<span class="sd">            [`pyodi train-config evaluation`][pyodi.apps.train_config.train_config_evaluation.train_config_evaluation]</span>
<span class="sd">            for more information.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Anchor generator instance.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df_annotations</span> <span class="o">=</span> <span class="n">coco_ground_truth_to_df</span><span class="p">(</span><span class="n">ground_truth_file</span><span class="p">)</span>

    <span class="n">df_annotations</span> <span class="o">=</span> <span class="n">filter_zero_area_bboxes</span><span class="p">(</span><span class="n">df_annotations</span><span class="p">)</span>

    <span class="n">df_annotations</span> <span class="o">=</span> <span class="n">scale_bbox_dimensions</span><span class="p">(</span>
        <span class="n">df_annotations</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> <span class="n">keep_ratio</span><span class="o">=</span><span class="n">keep_ratio</span>
    <span class="p">)</span>

    <span class="n">df_annotations</span> <span class="o">=</span> <span class="n">get_scale_and_ratio</span><span class="p">(</span><span class="n">df_annotations</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"scaled"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strides</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">base_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base_sizes</span> <span class="o">=</span> <span class="n">strides</span>

    <span class="c1"># Assign fpn level</span>
    <span class="n">df_annotations</span><span class="p">[</span><span class="s2">"fpn_level"</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_pyramid_level</span><span class="p">(</span>
        <span class="n">get_bbox_array</span><span class="p">(</span><span class="n">df_annotations</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"scaled"</span><span class="p">)[:,</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">base_sizes</span>
    <span class="p">)</span>

    <span class="n">df_annotations</span><span class="p">[</span><span class="s2">"fpn_level_scale"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_annotations</span><span class="p">[</span><span class="s2">"fpn_level"</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">base_sizes</span><span class="p">)}</span>
    <span class="p">)</span>

    <span class="n">df_annotations</span><span class="p">[</span><span class="s2">"level_scale"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_annotations</span><span class="p">[</span><span class="s2">"scaled_scale"</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_annotations</span><span class="p">[</span><span class="s2">"fpn_level_scale"</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Normalize to log scale</span>
    <span class="n">df_annotations</span><span class="p">[</span><span class="s2">"log_ratio"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_annotations</span><span class="p">[</span><span class="s2">"scaled_ratio"</span><span class="p">])</span>
    <span class="n">df_annotations</span><span class="p">[</span><span class="s2">"log_level_scale"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_annotations</span><span class="p">[</span><span class="s2">"level_scale"</span><span class="p">])</span>

    <span class="c1"># Cluster bboxes by scale and ratio independently</span>
    <span class="n">clustering_results</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">kmeans_euclidean</span><span class="p">(</span><span class="n">df_annotations</span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">([</span><span class="s2">"log_level_scale"</span><span class="p">,</span> <span class="s2">"log_ratio"</span><span class="p">],</span> <span class="p">[</span><span class="n">n_scales</span><span class="p">,</span> <span class="n">n_ratios</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Bring back from log scale</span>
    <span class="n">scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">**</span> <span class="n">clustering_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"centroids"</span><span class="p">]</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">**</span> <span class="n">clustering_results</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"centroids"</span><span class="p">]</span>

    <span class="n">anchor_generator</span> <span class="o">=</span> <span class="n">AnchorGenerator</span><span class="p">(</span>
        <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span> <span class="n">ratios</span><span class="o">=</span><span class="n">ratios</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="n">scales</span><span class="p">,</span> <span class="n">base_sizes</span><span class="o">=</span><span class="n">base_sizes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Anchor configuration: </span><span class="se">\n</span><span class="si">{</span><span class="n">anchor_generator</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">plot_clustering_results</span><span class="p">(</span>
        <span class="n">df_annotations</span><span class="p">,</span>
        <span class="n">anchor_generator</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
        <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">"COCO_anchor_generation"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">evaluate</span><span class="p">:</span>
        <span class="n">anchor_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">anchor_generator</span><span class="o">=</span><span class="n">anchor_generator</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="n">train_config_evaluation</span><span class="p">(</span>
            <span class="n">ground_truth_file</span><span class="o">=</span><span class="n">df_annotations</span><span class="p">,</span>
            <span class="n">anchor_config</span><span class="o">=</span><span class="n">anchor_config</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"anchor_config.py"</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">anchor_generator</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../train-config-evaluation/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                evaluation
              </div>
            </div>
          </a>
        
        
          <a href="../../core/anchor_generator/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                anchor_generator
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../../../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: [],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>